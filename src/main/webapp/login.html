<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="static/style.css">
    <style>
        .box {
            width: 70vw;
            height: 80vh;
            background: url(static/asset/bg.jpg);
            background-attachment: fixed;
            background-size: cover;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 30px;
            font-family: NeueMachina-Regular;
            overflow: hidden;
        }
    </style>
    <script src="js/jquery-3.6.0.min.js"></script>
</head>

<body>
    <div class="box">
        <div class="forms">
            <div class="tips">
                <span class="login-btn">login</span>
                <span class="register-btn">register</span>
            </div>
            <div class="login">
                <div class="form-title">
                    <h1>Hello</h1>
                    <h4>One click triple connection</h4>
                </div>
                <div class="form">
                    <div class="username input-item">
                        <input type="username" class="ipts" id="login-username">
                    </div>
                    <div class="password input-item">
                        <input type="password" class="ipts" id="login-password">
                    </div>
                    <div class="role-selection input-item" style="height: 20px">
                        <select id="login-role">
                            <option value="0">客户端</option>
                            <option value="1">后台管理</option>
                        </select>
                    </div>
                    <div class="remember-me">
                        <label>
                            <input type="checkbox" id="remember-me"> 记住我
                        </label>
                    </div>
                    <div id="error-message" style="color: red; display: none;"></div>
                    <button class="btn" id="login-btn">Login</button>
                </div>
            </div>
            <div class="register">
                <div class="form-title">
                    <h1>Register</h1>
                    <h4>One click triple connection</h4>
                </div>
                <div class="form">
                    <div class="username input-item">
                        <input type="text" class="ipts" id="register-username">
                    </div>
                    <div class="password input-item">
                        <input type="password" class="ipts" id="register-password">
                    </div>
                    <button class="btn" id="register-btn">Register</button>
                </div>
            </div>
            <div class="fogot-pwd">
                <div class="form-title">
                    <h1>fogot-pwd</h1>
                    <h4>One click triple connection</h4>
                </div>
                <div class="form">
                    <div class="username input-item">
                        <input type="text" class="ipts">
                    </div>
                    <div class="password input-item">
                        <input type="password" class="ipts">
                    </div>
                    <div class="code input-item">
                        <input type="text" class="ipts">
                        <span class="veri-code-tips">Click To Get</span>
                    </div>
                    <button class="btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    //注册
    $(document).ready(function() {
        // 注册按钮点击事件
        $('#register-btn').click(function() {
            // 获取输入框的值
            var username = $('#register-username').val();
            var password = $('#register-password').val();
            // 检查用户名是否已被占用
            checkUsername(username).then(function(isAvailable) {
                if (!isAvailable) {
                    alert('用户名已被占用，请选择其他用户名');
                    return;
                }
                // 构建请求数据
                var userData = {
                    username: username,
                    userPwd: password
                };
                // 发送 AJAX 请求
                $.ajax({
                    url: '/user/regist',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(userData),
                    success: function(response) {
                        if (response.code === 200) {
                            alert('注册成功！');
                        } else {
                            alert('注册失败：' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('请求失败：' + error);
                    }
                });
            });
        });
        // 用户名输入框失去焦点时进行校验
        $('#register-username').blur(function() {
            var username = $(this).val();
            checkUsername(username).then(function(isAvailable) {
                if (!isAvailable) {
                    alert('用户名已被占用，请选择其他用户名');
                }
            });
        });
        // 定义检查用户名是否被占用的函数
        function checkUsername(username) {
            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: '/user/checkUserName',
                    type: 'GET',
                    data: { username: username },
                    success: function(response) {
                        resolve(response.code === 200);
                    },
                    error: function(xhr, status, error) {
                        alert('检查用户名请求失败：' + error);
                        reject(false);
                    }
                });
            });
        }
    });


//登录
//     $(document).ready(function() {
//         $("#login-btn").click(function() {
//             // 获取用户名和密码
//             const username = $("#login-username").val();
//             const password = $("#login-password").val();
//
//             // 创建请求体
//             const requestBody = {
//                 username: username,
//                 userPwd: password
//             };
//
//             // 发送 AJAX 请求
//             $.ajax({
//                 url: '/user/login',
//                 type: 'POST',
//                 contentType: 'application/json',
//                 data: JSON.stringify(requestBody),
//                 success: function(data) {
//                     if (data.code === 200) {
//                         const rememberMe = $("#remember-me").prop("checked");
//                         const token = data.data.token;
//
//                         if (rememberMe) {
//                             // 持久化存储
//                             localStorage.setItem("username", username);
//                             localStorage.setItem("token", token);
//                             sessionStorage.removeItem("username");  // 清除会话存储
//                             sessionStorage.removeItem("token");
//                         } else {
//                             // 会话存储
//                             sessionStorage.setItem("username", username);
//                             sessionStorage.setItem("token", token);
//                             localStorage.removeItem("username");  // 清除持久化存储
//                             localStorage.removeItem("token");
//                         }
//                         alert("登录成功!");
//                         window.location.href = 'index.html';
//                     } else {
//                         $('#error-message').text("用户名或密码错误.").show();
//                     }
//                 },
//                 error: function(xhr, status, error) {
//                     console.error('Error:', error);
//                     alert("请求失败.");
//                 }
//             });
//         });
//         // 当密码输入框获取焦点时清空输入并隐藏错误信息
//         $('#login-password').focus(function() {
//             $(this).val(''); // 清空密码输入框
//             $('#error-message').hide(); // 隐藏错误信息
//         });
//     });

    $(document).ready(function() {
        let hasRedirected = false; // 跳转标志位

        $("#login-btn").click(function() {
            const username = $("#login-username").val();
            const password = $("#login-password").val();
            const selectedRole = $("#login-role").val(); // 新增：获取下拉框选择值

            const requestBody = {
                username: username,
                userPwd: password
            };

            $.ajax({
                url: '/user/login',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestBody),
                success: function(data) {
                    if (data.code === 200) {
                        const rememberMe = $("#remember-me").prop("checked");
                        const token = data.data.token;

                        // 存储 token 和用户名
                        const storage = rememberMe ? localStorage : sessionStorage;
                        storage.setItem("token", token);
                        storage.setItem("username", username);

                        // 清除另一种存储
                        const otherStorage = rememberMe ? sessionStorage : localStorage;
                        otherStorage.removeItem("token");
                        otherStorage.removeItem("username");

                        getUserInfo(token, selectedRole); // 传入选择的角色
                    } else {
                        $('#error-message').text("用户名或密码错误").show();
                    }
                },
                error: function(xhr) {
                    $('#error-message').text(`登录失败: ${xhr.responseJSON?.message || ''}`).show();
                }
            });
        });


// 获取用户信息函数改造
        function getUserInfo(token, selectedRole) {
            $.ajax({
                url: '/user/getUserInfo',
                type: 'GET',
                headers: { "token": token },
                success: function(userData) {
                    if (userData.code === 200) {
                        const userRole = userData.data.loginUser.role; // 数据库中角色
                        const storage = localStorage.getItem("token") ? localStorage : sessionStorage;
                        storage.setItem("role", userRole);

                        let redirectUrl = 'index.html';

                        // 根据用户选择决定跳转页面，不再检查权限
                        if (selectedRole === '1') {
                            redirectUrl = 'adminManage.html'; // 用户选择进入管理端
                        } else {
                            redirectUrl = 'index.html'; // 用户选择进入客户端
                        }

                        if (!hasRedirected) {
                            hasRedirected = true;
                            alert("登录成功!");
                            setTimeout(() => {
                                window.location.href = redirectUrl;
                            }, 500);
                        }

                    } else {
                        alert("用户信息获取失败");
                    }
                },
                error: function() {
                    alert("用户信息请求失败");
                    if (!hasRedirected) {
                        window.location.href = 'index.html';
                    }
                }
            });
        }



        // 保留密码框清空逻辑
        $('#login-password').focus(function() {
            $(this).val('');
            $('#error-message').hide();
        });
    });




    const login = document.querySelector('.login')
    const register = document.querySelector('.register')
    const fogotPwd = document.querySelector('.fogot-pwd')
    const registerBtn = document.querySelector('.register-btn')
    const loginBtn = document.querySelector('.login-btn')
    const fogotPwdBtn = document.querySelector('.fogot-pwd-btn')
    const veriCodeTips = document.querySelector('.veri-code-tips');
    let reckonTimeFlag = 5; //倒计时
    let reckonTime; //定时器
    //定时器
    function countDown() {
        veriCodeTips.innerHTML = `RESEND(${reckonTimeFlag})`
        reckonTimeFlag--;
        if (reckonTimeFlag < 0) {
            clearInterval(reckonTime);
            reckonTimeFlag = 5;
            veriCodeTips.innerHTML = `Click To Get`;
            veriCodeTips.style.color = "rgb(113 123 185)";
            veriCodeTips.onclick = veriCodeTipsClick;
        }
    }

    //点击事件触发的方法
    function veriCodeTipsClick() {
        veriCodeTips.onclick = null;
        veriCodeTips.style.color = "rgb(153, 151, 151)";
        reckonTime = setInterval(countDown, 1000);
        countDown();
    }

    veriCodeTips.addEventListener('click', function () {
        veriCodeTipsClick()
    })
    registerBtn.addEventListener('click', function () {
        login.style.opacity = '0'
        fogotPwd.style.opacity = '0'
        register.style.opacity = '1'
        login.style.zIndex = '-1'
        fogotPwd.style.zIndex = '-1'
        register.style.zIndex = '10'
        register.style.animation = 'into 1s ease'
        login.style.animation = 'none'
        fogotPwd.style.animation = 'none'
        registerBtn.style.borderBottom = '4px solid rgb(249, 177, 122)'
        registerBtn.style.color = '#fff'
        loginBtn.style.borderBottom = 'none'
        loginBtn.style.color = 'rgb(100, 108, 154)'
    })
    loginBtn.addEventListener('click', function () {
        login.style.opacity = '1'
        register.style.opacity = '0'
        fogotPwd.style.opacity = '0'
        login.style.zIndex = '10'
        fogotPwd.style.zIndex = '-1'
        register.style.zIndex = '-1'
        login.style.animation = 'into 1s ease'
        register.style.animation = 'none'
        fogotPwd.style.animation = 'none'
        registerBtn.style.borderBottom = ''
        registerBtn.style.color = 'rgb(100, 108, 154)'
        loginBtn.style.borderBottom = '4px solid rgb(249, 177, 122)'
        loginBtn.style.color = '#fff'
    })
</script>

</html>