<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta http-equiv="Cache-Control" content="no-store"/>
    <title>Clickaholic</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <!--    æ–‡æœ¬ç¼–è¾‘å™¨-->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="css/layui.css">
    <link rel="stylesheet" href="css/ai.css">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script src="js/layui.js"></script>
    <script src="js/jquery3.5.1.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function () {
            $('.dropdown-toggle').dropdown();
        });
    </script>
    <link rel="stylesheet" href="css/main.css">
    <style>




        #editor-container {
            height: 300px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px;
            background-color: white;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .file-progress {
            margin: 8px 0;
            padding: 5px;
            border: 1px solid #ddd;
        }

        .progress-bar {
            height: 20px;
            background-color: #2196F3;
            width: 0%;
            transition: width 0.3s ease;
        }

        .file-progress span {
            display: inline-block;
            margin-right: 10px;
            width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>

<body>
<!--Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark cyan fixed-top">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <img src="images/nav-logo.png" alt="nav-logo">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent-4"
                aria-controls="navbarSupportedContent-4" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent-4">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item ">
                    <a class="nav-link" href="index.html">é¦–é¡µ <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="typelist.html">æ–‡ç« åˆ†ç±»</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link" href="articlepublish.html">æ–‡ç« å‘è¡¨ </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="allarticle.html">æ–‡ç« åˆ—è¡¨</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="articlemanage.html">æˆ‘çš„æ–‡ç«  </a>
                </li>
                <li class="nav-item dropdown" id="username-display" style="display: none;">
                    <a class="nav-link dropdown-toggle" href="#" id="logged-username" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false"></a>
                    <div class="dropdown-menu" aria-labelledby="logged-username">
                        <a class="dropdown-item" href="myfavorite.html">æˆ‘çš„æ”¶è—</a>
                        <a class="dropdown-item" href="settings.html">è®¾ç½®</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" onclick="logout()">é€€å‡º</a> <!-- é€€å‡ºæ”¾å…¥ä¸‹æ‹‰èœå•å†… -->
                    </div>
                </li>
                <!-- ç™»å½•æ³¨å†ŒæŒ‰é’® -->
                <li class="nav-item" id="login-register" style="display: none;">
                    <a class="nav-link" href="login.html">ç™»å½• | æ³¨å†Œ</a>
                </li>
            </ul>
        </div>
    </div>
</nav>


<!-- æ–‡ç« å‘å¸ƒ-->
<section class="gallery-page">
    <div class="container">
        <h2>æ–‡ç« å‘å¸ƒ</h2>
        <div class="row justify-content-center">
            <div class="col-md-8">
                <form id="publishForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="title">æ ‡é¢˜</label>
                        <input type="text" class="form-control" id="title" name="title" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="type">ç±»åˆ«</label>
                        <select class="form-control" id="type" name="type" required>
                            <!-- åŠ¨æ€åŠ è½½ç±»åˆ« -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="content">å†…å®¹</label>
                        <!-- Quill ç¼–è¾‘å™¨ -->
                        <div id="editor-container"></div>
                    </div>
                    <div class="form-group">
                        <label for="image">ä¸Šä¼ å›¾ç‰‡</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*"
                               style="width: 230px;">
                    </div>
                    <div class="form-group">
                        <label for="attachments">ä¸Šä¼ é™„ä»¶</label>
                        <!-- æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼  -->
                        <input type="file" class="form-control" id="attachments" name="attachments" multiple>
                        <div id="progressContainer"></div>
                    </div>
                    <button type="button" id="publishButton" style="background-color: black; color: yellow;">å‘å¸ƒ
                    </button>
                </form>
                <div id="aiChatBtn" title="AI èŠå¤©">ğŸ¤–</div>
                <!-- AI èŠå¤©é¢æ¿ï¼ˆåˆå§‹éšè—ï¼‰ -->
                <div id="aiChatPane">
                    <div id="aiChatHeader">
                        <span>Deepseek V3</span>
                        <button id="aiChatClose">Ã—</button>
                    </div>
                    <div id="chatMessages"></div>
                    <div id="aiChatInputArea">
                        <input type="text" id="chatInput" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." />
                        <button id="chatSend" class="layui-btn layui-btn-normal layui-btn-sm">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>


<!--/.Portfolio-Section -->
<!-- Footer -->
<footer>

    <section class="footer-bottom">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li class="hidden">/</li>
                        <li><a href="typelist.html">About-us</a></li>
                        <li class="hidden">/</li>
                        <li><a href="mystories.html">My stories</a></li>
                        <li class="hidden">/</li>
                        <li><a href="destinations.html">Destinations</a></li>
                        <li class="hidden">/</li>
                        <li><a href="articlepublish.html">Gallery</a></li>
                        <li class="hidden">/</li>
                        <li><a href="articlemanage.html">Contact</a></li>
                    </ul>
                </div>
                <div class="col-md-12">
                    <p>(C) All Rights Reserved </p>
                </div>
            </div>
        </div>
    </section>
</footer>
<!-- /.Footer -->
<script src="js/auth.js"></script>
<script src="js/Ai.js"></script>
<script src="js/marked.js"></script>
<script>

    // åˆå§‹åŒ– Quill ç¼–è¾‘å™¨
    const quill = new Quill('#editor-container', {
        theme: 'snow', // ä½¿ç”¨ "snow" ä¸»é¢˜
        placeholder: 'åœ¨è¿™é‡Œç¼–è¾‘æ–‡ç« å†…å®¹...',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'], // æ ·å¼
                [{'list': 'ordered'}, {'list': 'bullet'}], // åˆ—è¡¨
                ['link', 'image'] // é“¾æ¥å’Œå›¾ç‰‡
            ]
        }
    });
    // åŠ¨æ€åŠ è½½æ–‡ç« ç±»åˆ«
    document.addEventListener("DOMContentLoaded", function () {
        fetch("/portal/findAllTypes")
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const typeSelect = document.getElementById("type");
                    data.data.forEach(type => {
                        const option = document.createElement("option");
                        option.value = type.tid; // æ ¹æ®åç«¯è¿”å›æ•°æ®ç»“æ„é€‰æ‹©æ­£ç¡®çš„å±æ€§
                        option.textContent = type.tname;
                        typeSelect.appendChild(option);
                    });
                } else {
                    alert("æ— æ³•åŠ è½½ç±»åˆ«åˆ—è¡¨ï¼Œè¯·ç¨åå†è¯•ï¼");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼");
            });
    });

    // æ–‡ç« å‘å¸ƒè¯·æ±‚
    // document.getElementById("publishButton").addEventListener("click", function () {
    //     const title = document.getElementById("title").value;
    //     const type = document.getElementById("type").value;
    //     const content = quill.root.innerHTML; // è·å–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨çš„ HTML å†…å®¹
    //     const image = document.getElementById("image").files[0];
    //
    //     const token = localStorage.getItem("token");
    //     if (!token) {
    //         alert("æœªæ£€æµ‹åˆ°ç™»å½•ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•ï¼");
    //         return;
    //     }
    //
    //     // ä½¿ç”¨ FormData å¤„ç†å¤šéƒ¨åˆ†è¡¨å•æ•°æ®
    //     const formData = new FormData();
    //     formData.append("title", title);
    //     formData.append("type", type);
    //     formData.append("article", content); // æäº¤ HTML æ ¼å¼å†…å®¹
    //     if (image) {
    //         formData.append("image", image); // æ·»åŠ å›¾ç‰‡æ–‡ä»¶
    //     }
    //
    //     fetch("/headline/publish", {
    //         method: "POST",
    //         headers: {
    //             "token": token // å°† token æ”¾å…¥è¯·æ±‚å¤´
    //         },
    //         body: formData // ç›´æ¥ä¼ é€’ FormData å¯¹è±¡
    //     })
    //         .then(response => response.json())
    //         .then(data => {
    //             if (data.code === 200) {
    //                 alert("æ–‡ç« å‘å¸ƒæˆåŠŸï¼");
    //                 document.getElementById("publishForm").reset();
    //                 quill.setContents([]); // æ¸…ç©ºå¯Œæ–‡æœ¬ç¼–è¾‘å™¨å†…å®¹
    //             } else {
    //                 alert("æ–‡ç« å‘å¸ƒå¤±è´¥ï¼š" + data.msg);
    //             }
    //         })
    //         .catch(error => {
    //             console.error("Error:", error);
    //             alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ï¼");
    //         });
    // });

    document.addEventListener("DOMContentLoaded", function () {
        const publishButton = document.getElementById("publishButton");
        const attachmentsInput = document.getElementById("attachments");
        const progressContainer = document.getElementById("progressContainer");
        let attachmentIds = []; // å­˜å‚¨æ‰€æœ‰å·²ä¸Šä¼ é™„ä»¶çš„ID

        // ç›‘å¬æ–‡ä»¶é€‰æ‹©äº‹ä»¶ï¼šç”¨æˆ·é€‰æ‹©æ–‡ä»¶åç«‹å³å¼€å§‹ä¸Šä¼ 
        attachmentsInput.addEventListener("change", function (e) {
            const files = e.target.files;
            if (files.length === 0) return;

            // æ¸…ç©ºæ—§æ•°æ®å’Œè¿›åº¦æ¡
            attachmentIds = [];
            progressContainer.innerHTML = "";

            // é€ä¸ªä¸Šä¼ æ–‡ä»¶
            Array.from(files).forEach(file => {
                uploadFile(file);
            });
        });

        // å•ä¸ªæ–‡ä»¶ä¸Šä¼ å‡½æ•°
        function uploadFile(file) {
            const formData = new FormData();
            formData.append("attachment", file); // å‚æ•°åå¿…é¡»ä¸åç«¯ä¸€è‡´
            console.log("Uploading file:", file.name, file.size);

            // åˆ›å»ºç‹¬ç«‹çš„è¿›åº¦æ¡å…ƒç´ 
            const progressDiv = document.createElement("div");
            progressDiv.className = "file-progress";
            const fileNameSpan = document.createElement("span");
            fileNameSpan.textContent = file.name;
            const progressBar = document.createElement("div");
            progressBar.className = "progress-bar";
            progressDiv.appendChild(fileNameSpan);
            progressDiv.appendChild(progressBar);
            progressContainer.appendChild(progressDiv);

            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/headline/attachmentUploads"); // ç¡®ä¿URLæ­£ç¡®

            // ä¸Šä¼ è¿›åº¦ç›‘å¬
            xhr.upload.addEventListener("progress", function (e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percent + "%";
                }
            });

            xhr.onload = function () {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.code === 200) {
                        // å­˜å‚¨è¿”å›çš„é™„ä»¶ID
                        attachmentIds.push(response.data);
                        progressBar.style.backgroundColor = "#4CAF50"; // ç»¿è‰²è¡¨ç¤ºæˆåŠŸ
                        progressBar.textContent = " ä¸Šä¼ æˆåŠŸ âœ”"; // æˆåŠŸæç¤º
                    } else {
                        progressBar.style.backgroundColor = "#f44336"; // çº¢è‰²è¡¨ç¤ºå¤±è´¥
                        progressBar.textContent = " ä¸Šä¼ å¤±è´¥ âœ–"; // å¤±è´¥æç¤º
                    }
                }
            };


            xhr.onerror = function () {
                progressBar.style.backgroundColor = "#f44336";
            };

            xhr.send(formData);
        }

        // å‘å¸ƒæ–‡ç« é€»è¾‘ï¼ˆåªæäº¤æ–‡ç« å†…å®¹å’Œå·²ä¸Šä¼ çš„é™„ä»¶IDï¼‰
        document.getElementById("publishButton").addEventListener("click", function () {
            const formData = new FormData(document.getElementById("publishForm"));

            // è·å– Quill ç¼–è¾‘å™¨å†…å®¹ï¼Œå¹¶æ·»åŠ åˆ° formData
            const articleContent = quill.root.innerHTML.trim();
            if (!articleContent) {
                alert("æ–‡ç« å†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
                return;
            }
            formData.append("article", articleContent);

            // æ·»åŠ é™„ä»¶IDåˆ°è¡¨å•æ•°æ®
            if (attachmentIds.length > 0) {
                formData.append("attachmentIds", JSON.stringify(attachmentIds)); // ç¡®ä¿æ˜¯ JSON æ•°ç»„æ ¼å¼
            }
            console.log("å‘é€çš„æ•°æ®11:", formData);
            // å‘é€è¯·æ±‚
            fetch("/headline/publish", {
                method: "POST",
                headers: {
                    "token": localStorage.getItem("token")
                },
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200) {
                        alert("æ–‡ç« å‘å¸ƒæˆåŠŸï¼");
                        window.location.reload();
                    } else {
                        alert("é”™è¯¯ï¼š" + data.message);
                    }
                })
                .catch(error => {
                    console.error("å‘å¸ƒå¤±è´¥:", error);
                    alert("å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
                });
        });
    });


</script>
</body>
</html>
